{% extends 'base.html' %}

{% block meta %}
<link rel="stylesheet" type="text/css" href="/media/css/game.css" type="text/css" />
{% endblock meta %}

{% block header_title %}
Wooooooooo
{% endblock header_title %}

{% block style %}
{% endblock style %}

{% block content %}

    <ul id="phases">
        <li class="active draw">
            Draw
        </li>
        <li class="play play_1">
            Play (offensive)
        </li>
        <li class="attack">
            Attack
        </li>
        <li class="play play_2">
            Play (strategic)
        </li>
    </ul>

    <div class="enemy board">
        {% for node in board %}
            <div class="node empty" style="left:{{node.board_x_enemy}}px;top:{{node.board_y_enemy}}px;">
            </div>
        {% endfor %}
    </div>

    <div id="enemy_tech" class="tech">
        <h1>T1</h1>
    </div>

    <div class="friendly board">
        {% for node in board %}
            <div class="node empty" style="left:{{node.board_x_friendly}}px;top:{{node.board_y_friendly}}px;">
            </div>
        {% endfor %}
    </div>

    <ul id="friendly_hand">
    </ul>

    <div id="friendly_tech" class="tech">
        <h1>T1</h1>
    </div>

    <script>

        var UNIT_R = 25;

        var phases = ["draw", "play_1", "attack", "play_2"];
        var phase = 0;
        var tech_level = 1;
        var MAX_TECH = 5;

        //hand_cards[card_pk] = card.fields
        var hand_cards = {};

        //same format as hand_cards, but contains
        //every card played so far this game as a
        //lookup for what's already happened
        var played_cards = {};
        
        $(function() {
            draw();
        });
        function draw() {
            //visual feedback about which phase we're in
            $("#phases li").removeClass("active");
            $("#phases .draw").addClass("active");

            $.ajax({ url: "/playing/draw/",
                success: function(hand_data_text) {
                    //convert to json
                    hand_data = eval('(' + hand_data_text + ')');

                    //clear old cards
                    hand_cards = {};
                    $("#friendly_hand").empty();

                    for (var i = 0; i < hand_data.length; i ++) {
                        var card_json = hand_data[i];

                        //display card in hand area
                        add_card_to_hand(card_json);

                        //track it for lookup when its played
                        hand_cards[card_json.pk] = card_json.fields;
                    }
                    next_phase();
                }
            }); 
        }

        function next_phase() {

            phase ++;
            cancel_cast();

            if (phase >= phases.length) {
                phase = 0;
                $("#phases li.active").removeClass("active").siblings().first().addClass("active");
            }
            else {
                $("#phases li.active").removeClass("active").next().addClass("active");
            }

            if (phase == 0) {
                //draw cards
                draw(); 
            }
            else if (phase == 2) {
                //begin logic for auto-attacking
                setTimeout(next_phase, 1000);
            }
        }

        function add_card_to_hand(card_json) {
            var card = $("<li class='card' id='" + card_json.pk + "'>T" + card_json.fields.tech_level + " " + card_json.fields.name + "</li>").appendTo("#friendly_hand");

            card.click( function(event) {

                cancel_cast();

                if (phase != 1 && phase != 3) {
                    //not in an interactive phase, so no clicky
                    return;
                }
                if (tech_level < card_json.fields.tech_level 
                    && tech_level > MAX_TECH) {

                    //we can neither play nor tech up with this
                    //card, so don't allow it to be clicked
                    return;
                }

                $(this).addClass("selected");

                // if the tech level is high enough, select the places
                // on the board we can use this card
                if (tech_level >= card_json.fields.tech_level) {
                    // find valid targets based on card targetting type
                    // e.g. summoning is: friendly board > empty nodes
                    var targets = $(".board." + card_json.fields.target_alignment + " ." + card_json.fields.target_occupant);

                    // highlight valid targets and allow them to respond to click
                    targets.addClass("targettable").click( function (event) {
                        cast($(".card.selected"), $(this));
                    });
                }

                // and if we have already teched fully, 
                // don't allow it to go higher
                if (tech_level < MAX_TECH) {
                    $("#friendly_tech").addClass("targettable").click( function (event) {
                        trash($(".card.selected"));
                    });
                }
            });
        }

        function trash(hand_card) {

            if (phase != 1 && phase != 3) {
                //not in an interactive phase, so no clicky
                return;
            }

            //visually remove from hand
            hand_card.remove();

            tech_up(1);

            next_phase();
        }

        function tech_up(amount) {

            //tech up one notch
            tech_level += amount; 

            if (tech_level > MAX_TECH) tech_level = MAX_TECH;

            $("#friendly_tech h1").text("T" + tech_level);
        }

        function cast(hand_card, node) { 

            if (phase != 1 && phase != 3) {
                //not in an interactive phase, so no clicky
                return;
            }

            //visually remove from hand
            hand_card.remove();

            //convert jquery element into json w/ game logic
            var card = hand_cards[hand_card.attr("id")];

            if (card.defense) {
                //create a summon
                node.addClass("unit");
                node.addClass("occupied"); 

                node.removeClass("empty");

                //for lookup of unit behaviour later
                node.attr("id", hand_card.attr("id"));

                played_cards[hand_card.attr("id")] = hand_card.fields;

                var unit = $("<div class='unit' id='" + card.pk + "'>" + card.attack + "/" + card.defense + card.attack_type[0] + "</div>").appendTo(node);

            }

            next_phase();
        }

        function cancel_cast() {
            $(".card").removeClass("selected");

            //clear old targetting events 
            $(".node").removeClass("targettable").unbind("click");

            $("#friendly_tech").removeClass("targettable").unbind("click");
        }

    </script>
{% endblock content %}
